#!/bin/bash
# Ambient Watcher ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆè¨­å®šåˆæœŸåŒ–ã‚¹ã‚¯ãƒªãƒ—ãƒˆ

# ã‚«ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

echo -e "${BLUE}==================================${NC}"
echo -e "${BLUE} Ambient Watcher è¨­å®šåˆæœŸåŒ–${NC}"
echo -e "${BLUE}==================================${NC}"
echo ""

# ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ«ãƒ¼ãƒˆã‚’ç¢ºèª
if [ ! -d ".git" ]; then
    echo -e "${YELLOW}è­¦å‘Š: ç¾åœ¨ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã¯Gitãƒªãƒã‚¸ãƒˆãƒªã®ãƒ«ãƒ¼ãƒˆã§ã¯ãªã„ã‚ˆã†ã§ã™ã€‚${NC}"
    read -p "ç¶šè¡Œã—ã¾ã™ã‹ï¼Ÿ (y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        exit 1
    fi
fi

# .ambient_watcherãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ä½œæˆ
if [ -d ".ambient_watcher" ]; then
    echo -e "${YELLOW}.ambient_watcherãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã¯æ—¢ã«å­˜åœ¨ã—ã¾ã™ã€‚${NC}"
    read -p "ä¸Šæ›¸ãã—ã¾ã™ã‹ï¼Ÿ (y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        exit 1
    fi
fi

echo "è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¦ã„ã¾ã™..."
mkdir -p .ambient_watcher/prompts

# config.tomlã®ä½œæˆ
cat > .ambient_watcher/config.toml << 'EOF'
# Ambient Watcher ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆè¨­å®š
# ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã§ãƒ¬ãƒ“ãƒ¥ãƒ¼ã®å†…å®¹ã‚„è¦³ç‚¹ã‚’ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã§ãã¾ã™

# ãƒ¬ãƒ“ãƒ¥ãƒ¼å…¨ä½“ã®æœ‰åŠ¹/ç„¡åŠ¹
enabled = true

# é™¤å¤–ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼ˆã“ã‚Œã‚‰ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¯ãƒ¬ãƒ“ãƒ¥ãƒ¼ã•ã‚Œã¾ã›ã‚“ï¼‰
exclude_patterns = [
    "target/**",
    "node_modules/**",
    ".git/**",
    "dist/**",
    "build/**",
    "*.min.js",
    "*.min.css",
    "vendor/**",
]

# ============================================
# ãƒ¬ãƒ“ãƒ¥ãƒ¼è¨­å®š
# ============================================

# æ§‹æ–‡ã‚¨ãƒ©ãƒ¼ãƒ»å‹ã‚¨ãƒ©ãƒ¼ãƒã‚§ãƒƒã‚¯
[[reviews]]
name = "æ§‹æ–‡ã‚¨ãƒ©ãƒ¼ãƒ»å‹ã‚¨ãƒ©ãƒ¼ãƒã‚§ãƒƒã‚¯"
description = "ã‚³ãƒ¼ãƒ‰ã®æ§‹æ–‡ã‚¨ãƒ©ãƒ¼ã¨å‹ã®ä¸ä¸€è‡´ã‚’æ¤œå‡º"
file_patterns = ["*.rs", "*.ts", "*.tsx", "*.js", "*.jsx", "*.py", "*.go"]
priority = 200
enabled = true
prompt = """
ã‚ãªãŸã¯ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã§ã™ã€‚`{file_path}`ã‚’åˆ†æã—ã¦ã€ä»¥ä¸‹ã‚’æ—¥æœ¬èªã§å ±å‘Šã—ã¦ãã ã•ã„ï¼š

1. æ§‹æ–‡ã‚¨ãƒ©ãƒ¼ã®å¯èƒ½æ€§ãŒã‚ã‚‹ç®‡æ‰€ï¼ˆæœªå®šç¾©å¤‰æ•°ã€æ‹¬å¼§ã®ä¸ä¸€è‡´ã€ã‚»ãƒŸã‚³ãƒ­ãƒ³å¿˜ã‚Œãªã©ï¼‰
2. å‹ã®ä¸ä¸€è‡´ã®å¯èƒ½æ€§
3. ã‚¨ãƒ©ãƒ¼ãŒã‚ã‚‹å ´åˆã¯`{file_path}:è¡Œç•ªå·`ã®å½¢å¼ã§ãƒªãƒ³ã‚¯ã‚’æä¾›

ã‚¨ãƒ©ãƒ¼ãŒãªã„å ´åˆã¯ã€æ§‹æ–‡ã‚¨ãƒ©ãƒ¼ã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€ã¨ç­”ãˆã¦ãã ã•ã„ã€‚
"""

# ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒªã‚¹ã‚¯æ¤œå‡º
[[reviews]]
name = "ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒªã‚¹ã‚¯æ¤œå‡º"
description = "ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è„†å¼±æ€§ã¨ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰ã•ã‚ŒãŸç§˜å¯†æƒ…å ±ã‚’æ¤œå‡º"
file_patterns = ["*"]
priority = 150
enabled = true
prompt = """
ã‚ãªãŸã¯ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¨ã‚­ã‚¹ãƒ‘ãƒ¼ãƒˆã§ã™ã€‚`{file_path}`ã‚’åˆ†æã—ã¦ã€ä»¥ä¸‹ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒªã‚¹ã‚¯ã‚’æ—¥æœ¬èªã§å ±å‘Šã—ã¦ãã ã•ã„ï¼š

1. ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰ã•ã‚ŒãŸAPIã‚­ãƒ¼ã€ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã€ãƒˆãƒ¼ã‚¯ãƒ³
2. SQLã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ã€XSSã®è„†å¼±æ€§
3. å®‰å…¨ã§ãªã„å…¥åŠ›æ¤œè¨¼
4. ã‚¨ãƒ©ãƒ¼ç®‡æ‰€ã¯`{file_path}:è¡Œç•ªå·`å½¢å¼ã§

ãƒªã‚¹ã‚¯ãŒãªã„å ´åˆã¯ã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒªã‚¹ã‚¯ã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€ã¨ç­”ãˆã¦ãã ã•ã„ã€‚
"""

# ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–
[[reviews]]
name = "ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–"
description = "ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å•é¡Œã¨æœ€é©åŒ–ã®æ©Ÿä¼šã‚’æ¤œå‡º"
file_patterns = ["*.rs", "*.go", "*.cpp", "*.c", "*.py"]
priority = 100
enabled = true
prompt = """
ã‚ãªãŸã¯ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã‚¨ã‚­ã‚¹ãƒ‘ãƒ¼ãƒˆã§ã™ã€‚`{file_path}`ã‚’åˆ†æã—ã¦ã€ä»¥ä¸‹ã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å•é¡Œã‚’æ—¥æœ¬èªã§å ±å‘Šã—ã¦ãã ã•ã„ï¼š

1. O(nÂ²)ä»¥ä¸Šã®è¨ˆç®—é‡ã®å‡¦ç†
2. ä¸è¦ãªãƒ«ãƒ¼ãƒ—ã‚„ãƒ¡ãƒ¢ãƒªãƒªãƒ¼ã‚¯
3. ã‚ˆã‚ŠåŠ¹ç‡çš„ãªå®Ÿè£…æ–¹æ³•ã®ææ¡ˆ
4. å•é¡Œç®‡æ‰€ã¯`{file_path}:è¡Œç•ªå·`å½¢å¼ã§

å•é¡ŒãŒãªã„å ´åˆã¯ã€ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å•é¡Œã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€ã¨ç­”ãˆã¦ãã ã•ã„ã€‚
"""

# ============================================
# ã‚«ã‚¹ã‚¿ãƒ ãƒ¬ãƒ“ãƒ¥ãƒ¼ã®ä¾‹ï¼ˆç„¡åŠ¹åŒ–ã•ã‚Œã¦ã„ã¾ã™ï¼‰
# ============================================

# [[reviews]]
# name = "ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆè¦ç´„ãƒã‚§ãƒƒã‚¯"
# description = "ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå›ºæœ‰ã®ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¦ç´„ã‚’ç¢ºèª"
# file_patterns = ["src/**/*.rs"]
# priority = 300
# enabled = false
# prompt = """
# ã“ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¦ç´„ã«å¾“ã£ã¦ãƒ¬ãƒ“ãƒ¥ãƒ¼ã—ã¦ãã ã•ã„ï¼š
# 1. é–¢æ•°ã¯30è¡Œä»¥å†…
# 2. ãƒã‚¹ãƒˆã¯3æ®µéšã¾ã§
# 3. ã‚¨ãƒ©ãƒ¼å‡¦ç†ã¯å¿…ãšResultå‹ã‚’ä½¿ç”¨
# """

# ============================================
# ã‚«ã‚¹ã‚¿ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆï¼ˆåˆ¥ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰èª­ã¿è¾¼ã‚€å ´åˆï¼‰
# ============================================

# [[custom_prompts]]
# id = "architecture_review"
# content = """
# ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ãƒ¬ãƒ“ãƒ¥ãƒ¼ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ...
# """
EOF

# READMEã®ä½œæˆ
cat > .ambient_watcher/README.md << 'EOF'
# Ambient Watcher ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆè¨­å®š

ã“ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ã¯ã€Ambient Watcherã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå›ºæœ‰ã®è¨­å®šãŒå«ã¾ã‚Œã¦ã„ã¾ã™ã€‚

## ğŸš€ ã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆ

```bash
# Ambient Watcherã‚’èµ·å‹•
ambient

# ãƒ–ãƒ©ã‚¦ã‚¶ã‚‚è‡ªå‹•ã§é–‹ã
ambient --open
```

## ğŸ“ ãƒ•ã‚¡ã‚¤ãƒ«æ§‹æˆ

```
.ambient_watcher/
â”œâ”€â”€ config.toml      # ãƒ¡ã‚¤ãƒ³è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«
â”œâ”€â”€ prompts/         # ã‚«ã‚¹ã‚¿ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
â””â”€â”€ README.md        # ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«
```

## âš™ï¸ è¨­å®šã®ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º

### ãƒ¬ãƒ“ãƒ¥ãƒ¼ã®è¿½åŠ 

`config.toml`ã«æ–°ã—ã„ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ ï¼š

```toml
[[reviews]]
name = "ã‚«ã‚¹ã‚¿ãƒ ãƒ¬ãƒ“ãƒ¥ãƒ¼"
description = "ç‹¬è‡ªã®ãƒ¬ãƒ“ãƒ¥ãƒ¼è¦³ç‚¹"
file_patterns = ["src/**/*.rs"]
priority = 300  # é«˜ã„ã»ã©å„ªå…ˆ
enabled = true
prompt = """
ã“ã“ã«ãƒ¬ãƒ“ãƒ¥ãƒ¼ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’è¨˜è¿°
{file_path}ã¯è‡ªå‹•çš„ã«ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ã«ç½®æ›ã•ã‚Œã¾ã™
"""
```

### é™¤å¤–ãƒ‘ã‚¿ãƒ¼ãƒ³ã®è¨­å®š

ç‰¹å®šã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚„ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’é™¤å¤–ï¼š

```toml
exclude_patterns = [
    "target/**",
    "tests/**",
    "*.generated.rs"
]
```

### ãƒ¬ãƒ“ãƒ¥ãƒ¼ã®å„ªå…ˆé †ä½

- `priority`å€¤ãŒé«˜ã„ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‹ã‚‰é †ã«å®Ÿè¡Œã•ã‚Œã¾ã™
- ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã¯100
- æ¨å¥¨å€¤ï¼š
  - 300+: æœ€é‡è¦ï¼ˆãƒ“ãƒ«ãƒ‰ã‚¨ãƒ©ãƒ¼ãªã©ï¼‰
  - 200: é‡è¦ï¼ˆæ§‹æ–‡ã‚¨ãƒ©ãƒ¼ï¼‰
  - 150: ä¸­ç¨‹åº¦ï¼ˆã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ï¼‰
  - 100: é€šå¸¸ï¼ˆæœ€é©åŒ–ææ¡ˆï¼‰
  - 50ä»¥ä¸‹: ä½å„ªå…ˆåº¦

## ğŸ¯ ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¿ãƒ¼ãƒ³

ä»¥ä¸‹ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ãŒä½¿ç”¨ã§ãã¾ã™ï¼š

- `*.rs` - æ‹¡å¼µå­ã«ã‚ˆã‚‹æŒ‡å®š
- `src/**/*.rs` - ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªé…ä¸‹ã®å…¨ãƒ•ã‚¡ã‚¤ãƒ«
- `*` - ã™ã¹ã¦ã®ãƒ•ã‚¡ã‚¤ãƒ«
- `!test_*.rs` - é™¤å¤–ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼ˆexclude_patternsã§ä½¿ç”¨ï¼‰

## ğŸ’¡ Tips

1. **ç‰¹å®šã®ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ç„¡åŠ¹åŒ–**: `enabled = false`ã‚’è¨­å®š
2. **ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå…¨ä½“ã‚’ç„¡åŠ¹åŒ–**: ãƒˆãƒƒãƒ—ãƒ¬ãƒ™ãƒ«ã®`enabled = false`
3. **é•·ã„ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ**: `prompts/`ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«åˆ¥ãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦ä¿å­˜å¯èƒ½

## ğŸ”§ ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

- è¨­å®šãŒåæ˜ ã•ã‚Œãªã„å ´åˆã¯ã€Ambient Watcherã‚’å†èµ·å‹•ã—ã¦ãã ã•ã„
- æ§‹æ–‡ã‚¨ãƒ©ãƒ¼ãŒã‚ã‚‹å ´åˆã¯ã€`ambient`ã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œæ™‚ã«ã‚¨ãƒ©ãƒ¼ãŒè¡¨ç¤ºã•ã‚Œã¾ã™
EOF

# .gitignoreã¸ã®è¿½åŠ ã‚’ææ¡ˆ
if [ -f .gitignore ]; then
    if ! grep -q ".ambient_watcher/cache" .gitignore 2>/dev/null; then
        echo -e "${YELLOW}.gitignoreã«ä»¥ä¸‹ã‚’è¿½åŠ ã™ã‚‹ã“ã¨ã‚’ãŠå‹§ã‚ã—ã¾ã™ï¼š${NC}"
        echo ".ambient_watcher/cache/"
        echo ".ambient_watcher/*.log"
    fi
fi

echo ""
echo -e "${GREEN}âœ… è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¾ã—ãŸï¼${NC}"
echo ""
echo "ä½œæˆã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ï¼š"
echo "  - .ambient_watcher/config.toml (è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«)"
echo "  - .ambient_watcher/README.md (ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ)"
echo ""
echo -e "${BLUE}æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ï¼š${NC}"
echo "1. .ambient_watcher/config.toml ã‚’ç·¨é›†ã—ã¦ãƒ¬ãƒ“ãƒ¥ãƒ¼è¨­å®šã‚’ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º"
echo "2. ambient ã‚³ãƒãƒ³ãƒ‰ã§Ambient Watcherã‚’èµ·å‹•"
echo ""